<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD SQL Map 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.uce.omg.sso.dao.portal.IPortalPermissionDao">
	
	<!-- 查询用户所有权限 -->
	<!-- modify by zhangRb 20180821 portal菜单展示功能改造 -->
	<!-- <select id="findPortalPermissionByUser" resultType="cn.uce.omg.sso.vo.portal.PortalPermissionVo">
		SELECT DISTINCT
		OMG_PORTAL_PERMISSION.ID, 
		OMG_PORTAL_PERMISSION.PERMISSION_NAME,
		OMG_PORTAL_PERMISSION.PERMISSION_CODE, 
		OMG_PORTAL_PERMISSION.LEAF_FLAG, 
		OMG_PORTAL_PERMISSION.PERMISSION_URL, 
		OMG_PORTAL_PERMISSION.PARENT_PERMISSION,
		OMG_PORTAL_PERMISSION.SYS_URL,
		OMG_PORTAL_PERMISSION.PERMISSION_ICON,
		OMG_PORTAL_PERMISSION.SORT,
		OMG_PORTAL_PERMISSION.SYSTEM_CODE,
		OMG_PORTAL_PERMISSION.IS_HIDE as isHide
		FROM 
		OMG_PORTAL_PERMISSION 
		INNER JOIN 
		OMG_PORTAL_ROLE_PERMISSION_REL 
		ON OMG_PORTAL_PERMISSION.PERMISSION_CODE=OMG_PORTAL_ROLE_PERMISSION_REL.PERMISSION_CODE
		AND OMG_PORTAL_PERMISSION.SYSTEM_CODE = OMG_PORTAL_ROLE_PERMISSION_REL.SYSTEM_CODE 
		WHERE  
		OMG_PORTAL_PERMISSION.DELETE_FLAG = 0  
		<if test="controlType != null and controlType != 0">
		AND OMG_PORTAL_PERMISSION.CONTROL_TYPE = #{controlType}
		</if>
		AND EXISTS (SELECT ROLE_CODE FROM OMG_PORTAL_USER_ROLE_REL WHERE EMP_CODE = #{empCode} AND ROLE_CODE = OMG_PORTAL_ROLE_PERMISSION_REL.ROLE_CODE)
		ORDER BY OMG_PORTAL_PERMISSION.SORT
	</select> -->
	<select id="findPortalRolePermissionCodeByUser" resultType="java.lang.String">
		SELECT DISTINCT
		OMG_PORTAL_PERMISSION.PERMISSION_CODE
		FROM 
		OMG_PORTAL_PERMISSION 
		INNER JOIN 
		OMG_PORTAL_ROLE_PERMISSION_REL 
		ON OMG_PORTAL_PERMISSION.PERMISSION_CODE=OMG_PORTAL_ROLE_PERMISSION_REL.PERMISSION_CODE
		AND OMG_PORTAL_PERMISSION.SYSTEM_CODE = OMG_PORTAL_ROLE_PERMISSION_REL.SYSTEM_CODE 
		WHERE  
		OMG_PORTAL_PERMISSION.DELETE_FLAG = 0  
		AND EXISTS (SELECT ROLE_CODE FROM OMG_PORTAL_USER_ROLE_REL WHERE EMP_CODE = #{empCode} AND ROLE_CODE = OMG_PORTAL_ROLE_PERMISSION_REL.ROLE_CODE)
		ORDER BY OMG_PORTAL_PERMISSION.SORT
	</select>
	<select id="findPortalPermissionByUser" resultType="cn.uce.omg.sso.vo.portal.PortalPermissionVo">
		SELECT DISTINCT
		OPP.ID, 
		CASE WHEN OPM.PERMISSION_ALIAS_NAME IS NULL OR OPM.PERMISSION_ALIAS_NAME = '' 
			 THEN OPP.PERMISSION_NAME 
			 ELSE OPM.PERMISSION_ALIAS_NAME END PERMISSION_NAME,
		OPP.PERMISSION_CODE, 
		OPP.LEAF_FLAG, 
		OPP.PERMISSION_URL, 
		OPM.PARENT_PERMISSION,
		OPP.SYS_URL,
		OPP.PERMISSION_ICON,
		OPM.SORT,
		OPP.SYSTEM_CODE,
		OPP.IS_HIDE as isHide
		FROM 
		OMG_PORTAL_PERMISSION OPP
		INNER JOIN OMG_PORTAL_ROLE_PERMISSION_REL OPRPR 
			ON OPP.PERMISSION_CODE=OPRPR.PERMISSION_CODE AND OPP.SYSTEM_CODE = OPRPR.SYSTEM_CODE 
		INNER JOIN OMG_PORTAL_MENU OPM 
			ON OPM.PERMISSION_CODE = OPP.PERMISSION_CODE AND OPM.SYSTEM_CODE = OPP.SYSTEM_CODE
    	WHERE  OPP.DELETE_FLAG = 0  
	    <if test="controlType != null and controlType != 0">
			AND OPP.CONTROL_TYPE = #{controlType}
		</if>
	    AND EXISTS (SELECT ROLE_CODE FROM OMG_PORTAL_USER_ROLE_REL 
	    				WHERE EMP_CODE = #{empCode} AND ROLE_CODE = OPRPR.ROLE_CODE)
		ORDER BY OPM.SORT
	</select>
	
	<select id="findPermissionAndSystemCode" resultType="cn.uce.omg.sso.vo.portal.PortalPermissionVo">
		SELECT
		OMG_PORTAL_PERMISSION.ID, 
		OMG_PORTAL_PERMISSION.PERMISSION_NAME,
		OMG_PORTAL_PERMISSION.PERMISSION_CODE, 
		OMG_PORTAL_PERMISSION.LEAF_FLAG, 
		OMG_PORTAL_PERMISSION.PERMISSION_URL, 
		OMG_PORTAL_PERMISSION.PARENT_PERMISSION,
		OMG_PORTAL_PERMISSION.SYS_URL,
		OMG_PORTAL_PERMISSION.PERMISSION_ICON,
		OMG_PORTAL_PERMISSION.SORT,
		OMG_PORTAL_PERMISSION.SYSTEM_CODE,
		OMG_PORTAL_PERMISSION.IS_HIDE as isHide
		FROM 
		OMG_PORTAL_PERMISSION 
		WHERE 
		OMG_PORTAL_PERMISSION.PERMISSION_CODE  = #{permissionCode}
		AND
		OMG_PORTAL_PERMISSION.SYSTEM_CODE = #{systemCode}
	</select>
	
	<select id="menuPermissionCheck" resultType="java.lang.Integer">
		SELECT
		COUNT(RPR.SYSTEM_CODE)
		FROM 
		OMG_PORTAL_ROLE_PERMISSION_REL RPR
		LEFT JOIN OMG_PORTAL_USER_ROLE_REL URR ON RPR.ROLE_CODE = URR.ROLE_CODE
		WHERE 
		URR.EMP_CODE = #{empCode}
		AND
		RPR.SYSTEM_CODE = #{systemCode}
	</select>
	
	<select id="findPermissionByIds" parameterType="java.util.List" resultType="cn.uce.omg.sso.vo.portal.PortalPermissionVo">
		SELECT 
	  		o.ID, 
			CASE WHEN m.PERMISSION_ALIAS_NAME IS NULL OR m.PERMISSION_ALIAS_NAME = '' 
				 THEN o.PERMISSION_NAME 
				 ELSE m.PERMISSION_ALIAS_NAME END PERMISSION_NAME,
			o.PERMISSION_CODE, 
			o.LEAF_FLAG, 
			o.PERMISSION_URL, 
			m.PARENT_PERMISSION,
			o.SYS_URL,
			o.PERMISSION_ICON,
			m.SORT,
			o.SYSTEM_CODE,
			o.IS_HIDE AS isHide
		FROM
	  		omg_portal_permission o 
	  		LEFT JOIN omg_portal_menu m 
	    	ON o.`PERMISSION_CODE` = m.`PERMISSION_CODE` 
	    	AND o.`SYSTEM_CODE` = m.`SYSTEM_CODE` 
		WHERE o.id in
			<foreach item="item" collection="list" open="(" separator="," close=")">
				#{item}
			</foreach>
	
	</select>
</mapper>
